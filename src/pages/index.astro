---
import BaseLayout from '../layouts/BaseLayout.astro';
import DynamicSection from '../components/DynamicSection.astro';
import { convexServer } from '@/lib/convex';
import { api } from '@convex/_generated/api';

// This is meant to be used for dynamic routes like [...slug].astro
// But for now we name it index-dynamic to test locally or replace index.astro after verification.

const { slug } = Astro.props; // Or fetch from params if this was a route file
const pageSlug = slug || '/'; 

const page = await convexServer.query(api.pages.getBySlug, { slug: pageSlug });
const blocks = await convexServer.query(api.content_blocks.getByPage, { page_slug: pageSlug });

if (!page) {
  // Handle 404 or fallback
}
---

<BaseLayout
  title={page?.seo_title || 'Guardman Chile'}
  description={page?.seo_description || ''}
  ogImage={page?.og_image}
>
  {
    blocks && blocks.length > 0 ? (
      blocks.map((block) => (
        <DynamicSection type={block.type} data={block.data} />
      ))
    ) : (
      // Fallback content or empty state
      <div class="py-20 text-center">
        <h1 class="text-4xl font-bold">Welcome to Guardman</h1>
        <p>Loading content from database...</p>
      </div>
    )
  }
</BaseLayout>
