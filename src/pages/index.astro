---
/**
 * Homepage - Guardman Chile
 * Complete landing page with all sections for security services.
 */

import BaseLayout from '@/layouts/BaseLayout.astro';
import Container from '@/components/ui/Container.astro';
import Section from '@/components/ui/Section.astro';
import Button from '@/components/ui/Button.astro';
import OrganizationSchema from '@/components/seo/OrganizationSchema.astro';
import FAQSchema from '@/components/seo/FAQSchema.astro';
import Hero from '@/components/sections/Hero.astro';
import ServiceFinder from '@/components/sections/ServiceFinder.astro';
import ServicesGrid from '@/components/sections/ServicesGrid.astro';
import SolutionsGrid from '@/components/sections/SolutionsGrid.astro';
import ClientsGrid from '@/components/sections/ClientsGrid.astro';
import GuardPodSection from '@/components/sections/GuardPodSection.astro';
import FAQ from '@/components/sections/FAQ.astro';
import { convexServer } from '@/lib/convex';
import { api } from '@convex/_generated/api';
import { site } from '@/data/site';


// SSR: Fetch all data from Convex at request time
let services = [];
let solutions = [];
let faqs = [];
let siteConfig = null;
let heroBlocks = [];
let guardPodBlocks = [];
let clients = [];

try {
  const [
    servicesData,
    solutionsData,
    faqsData,
    siteConfigData,
    contentBlocksData,
    clientsData
  ] = await Promise.all([
    convexServer.query(api.services.getAllServices),
    convexServer.query(api.solutions.getAllSolutions),
    convexServer.query(api.faqs.getAllFaqs),
    convexServer.query(api.site_config.get),
    convexServer.query(api.content_blocks.getByPage, { page_slug: '/' }),
    convexServer.query(api.partners.getAll),
  ]);

  services = servicesData;
  solutions = solutionsData;
  faqs = faqsData;
  siteConfig = siteConfigData;
  heroBlocks = contentBlocksData.filter(b => b.type === 'hero_video');
  guardPodBlocks = contentBlocksData.filter(b => b.type === 'guardpod_feature');
  clients = clientsData.filter(c => c.type === 'client').sort((a, b) => a.order - b.order);

} catch (e) {
  console.error('Error fetching data:', e);
}

// Page metadata
const pageTitle = 'Guardman Chile';
const pageDescription = siteConfig?.description || 'Empresa líder en seguridad privada en Chile. Guardias OS10 certificados, alarmas Ajax, patrullaje de condominios, módulos GuardPod y control de acceso. Cobertura en toda la Región Metropolitana sin contratos forzosos.';
const heroData = heroBlocks[0]?.data;
const guardPodData = guardPodBlocks[0]?.data;
const heroTitle = heroBlocks[0]?.title;
const heroSubtitle = heroBlocks[0]?.subtitle;
const guardPodTitle = guardPodBlocks[0]?.title;
const guardPodSubtitle = guardPodBlocks[0]?.subtitle;
const guardPodContent = guardPodBlocks[0]?.content;


---

<BaseLayout title={pageTitle} description={pageDescription}>
  {/* Schema.org Organization */}
  <OrganizationSchema 
    name="Guardman Chile"
    url="https://guardman.cl"
    description={pageDescription}
    email="info@guardman.cl"
    telephone="+56 9 3000 0010"
    address={{
      street: site.address.street,
      city: site.address.city,
      region: site.address.region,
      postalCode: site.address.postalCode,
      country: 'CL',
    }}
  />

  {/* Schema.org FAQ */}
  <FAQSchema faqs={faqs} />

  {/* HERO SECTION */}
  <Hero 
    title={heroTitle}
    subtitle={heroSubtitle}
    data={heroData}
  />

  {/* SERVICE FINDER - Floating card */}
  <ServiceFinder 
    services={services}
    solutions={solutions}
  />

  {/* SERVICIOS SECTION */}
  <ServicesGrid 
    services={services} 
    showAllLink={true}
  />

  {/* GUARDPOD - Featured Section */}
  <GuardPodSection 
    title={guardPodTitle}
    subtitle={guardPodSubtitle}
    description={guardPodContent}
    data={guardPodData}
  />

  {/* SOLUCIONES - Grid Section */}
  <SolutionsGrid
    solutions={solutions}
    title="Soluciones"
    subtitle="Tecnología y personal adaptado a cada sector"
    showAllLink={true}
    background="white"
  />



  {/* CLIENTES - New section from Stitch */}
  <ClientsGrid clients={clients} />

  {/* FAQ SECTION */}
  <FAQ 
    faqs={faqs} 
    maxItems={6}
  />


</BaseLayout>
