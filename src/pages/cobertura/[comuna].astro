---
/**
 * Dynamic Commune Coverage Page
 * Generates static pages for each RM commune for SEO
 * Target: "guardias seguridad Las Condes", "alarmas Ajax Maipu", etc.
 */

import BaseLayout from '@/layouts/BaseLayout.astro';
import Container from '@/components/ui/Container.astro';
import Section from '@/components/ui/Section.astro';
import Button from '@/components/ui/Button.astro';
import Card from '@/components/ui/Card.astro';
import Icon from '@/components/ui/Icon.astro';
import Breadcrumbs from '@/components/ui/Breadcrumbs.astro';
import LocalBusinessSchema from '@/components/seo/LocalBusinessSchema.astro';
import { site, getWhatsAppUrl } from '@/data/site';
import { convexServer } from '@/lib/convex';
import { api } from '@convex/_generated/api';
import { generateBreadcrumbSchema } from '@/utils/seo';

// SSR: fetch commune and related data from Convex
const { comuna } = Astro.params;
const commune = await convexServer.query(api.locations.getCommuneBySlug, { slug: comuna! });

if (!commune) {
  return Astro.redirect('/cobertura');
}

const allCommunes = await convexServer.query(api.locations.getAllCommunes);
const services = await convexServer.query(api.services.getAllServices);

// Generate SEO title and description
const title = commune.meta_title || `Seguridad Privada en ${commune.name} | Guardman`;
const description = commune.meta_description || `Servicios de seguridad privada en ${commune.name}, Región Metropolitana. Guardias de seguridad, vigilancia, monitoreo y protección profesional para empresas. Cotiza hoy con Guardman.`;
const ogImage = commune.og_image || `${Astro.url.origin}/og/communes/${comuna}.png`;

// Get other communes in the same zone for coverage section
const zoneCommunes = allCommunes.filter((c: any) => c.zone === commune.zone);

// Breadcrumb schema - 3 levels: Inicio > Cobertura > [Comuna]
const breadcrumbSchema = generateBreadcrumbSchema([
  { name: 'Inicio', url: '/' },
  { name: 'Cobertura', url: '/cobertura' },
  { name: commune.name, url: `/cobertura/${commune.slug}` },
]);

// Zone display names for Spanish
const zoneDisplayNames: Record<string, string> = {
  norte: 'Zona Norte',
  sur: 'Zona Sur',
  oriente: 'Zona Oriente',
  poniente: 'Zona Poniente',
  centro: 'Zona Centro',
};

// Local benefits - unique per commune
const getLocalBenefits = (communeName: string) => [
  {
    title: 'Cobertura Local',
    description: `Operativos en ${communeName} con conocimiento profundo de la zona y sus particularidades.`,
    icon: 'map-pin',
  },
  {
    title: 'Respuesta Rápida',
    description:
      'Tiempo de respuesta promedio menor a 15 minutos en zonas urbanas cubiertas.',
    icon: 'shield-check',
  },
  {
    title: 'Guardias OS10',
    description:
      'Personal certificado y en constante capacitación según normativa chilena vigente.',
    icon: 'users',
  },
  {
    title: 'Monitoreo 24/7',
    description:
      'Centro de operaciones activo las 24 horas, los 7 días de la semana.',
    icon: 'bell-alert',
  },
];

// Service icons mapping
const serviceIconMap: Record<string, string> = {
  'guardias-seguridad': 'shield-check',
  'patrullaje-condominios': 'users',
  'alarmas-ajax': 'bell-alert',
  guardpod: 'key',
  'drones-seguridad': 'drone',
  'control-acceso': 'key',
};

const localBenefits = getLocalBenefits(commune.name);
const zoneDisplayName = commune.zone ? zoneDisplayNames[commune.zone] : 'Sin zona';
---

<BaseLayout title={title} description={description} ogImage={ogImage} schema={breadcrumbSchema}>
  <LocalBusinessSchema
    city={commune.name}
    slug={commune.slug}
  />

  <!-- Hero Section -->
  <section class="relative bg-black py-24 px-4 overflow-hidden">
    <!-- Background layer -->
    <div class="absolute inset-0 opacity-20">
      <div class="absolute inset-0 bg-gradient-to-b from-black via-transparent to-black z-10"></div>
      <img src="https://images.unsplash.com/photo-1544006659-f0b21f04cb1d?ixlib=rb-4.0.3&auto=format&fit=crop&w=2000&q=80" alt="" class="w-full h-full object-cover grayscale" />
    </div>

    <Container class="relative z-20">
      <Breadcrumbs items={[
        { name: 'Cobertura', url: '/cobertura' },
        { name: `Seguridad en ${commune.name}` }
      ]} />

      <div class="max-w-4xl">
        <h1 class="text-4xl md:text-6xl font-semibold text-white mb-8 tracking-tight leading-[1.1]">
          Seguridad en<br/>
          <span class="text-white/40 italic">{commune.name}</span>
        </h1>
        
        <p class="text-lg md:text-xl text-white/50 mb-12 max-w-2xl leading-relaxed">
          Operación táctica y protección integral para empresas y condominios en {commune.name}. 
          Personal certificado OS10 con presencia local permanente.
        </p>

        <div class="flex flex-col sm:flex-row gap-4">
          <button class="px-8 py-4 bg-white text-black font-semibold rounded-lg hover:bg-gray-100 transition-colors">
            Solicitar análisis en zona
          </button>
          <a
            href={`tel:${site.phone.replace(/\s/g, '')}`}
            class="px-8 py-4 border border-white/20 text-white font-semibold rounded-lg hover:bg-white/10 transition-colors flex items-center justify-center gap-2"
          >
            {site.phone}
          </a>
        </div>
      </div>
    </Container>
  </section>

  <!-- Intro Section -->
  <Section background="white">
    <Container>
      <div class="max-w-4xl mx-auto">
        <div class="prose prose-lg prose-gray-900 max-w-none">
          <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-6">
            Empresa de Seguridad en {commune.name}
          </h2>

          <p class="text-gray-600 leading-relaxed mb-6">
            Guardman ofrece soluciones integrales de seguridad privada en {
              commune.name
            } y toda la Región Metropolitana. Con más de 10 años de experiencia en el
            mercado chileno, brindamos protección profesional para empresas,
            condominios residenciales, empresas y comercios de la zona.
          </p>

          <p class="text-gray-600 leading-relaxed mb-6">
            Nuestros equipos de guardias de seguridad cuentan con certificación
            OS10 vigente y capacitación continua. Operamos con supervisión las
            24 horas mediante nuestro centro de monitoreo equipado con
            tecnología GPS de última generación, garantizando tiempos de
            respuesta efectivos en {commune.name} y sus alrededores.
          </p>

          <p class="text-gray-600 leading-relaxed">
            Además del servicio de guardias, ofrecemos sistemas de alarmas Ajax
            Systems, patrullaje de condominios, módulos GuardPod para obras,
            control de acceso biométrico y vigilancia con drones. Cada solución
            se adapta a las necesidades específicas de cada cliente en {
              commune.name
            }.
          </p>
        </div>
      </div>
    </Container>
  </Section>

  <!-- Services Grid -->
  <Section background="gray">
    <Container>
      <div class="mb-16">
        <h2 class="text-3xl md:text-4xl font-semibold text-gray-900 mb-4 tracking-tight">
          Protocolos disponibles
        </h2>
        <p class="text-gray-500 text-lg">Soluciones de seguridad táctica en {commune.name}.</p>
      </div>

      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
        {
          services.map((service: any) => (
            <a href={`/servicios/${service.slug}`} class="block group bg-white p-8 rounded-xl border border-gray-100 hover:border-black transition-all">
               <div class="w-10 h-10 rounded-lg bg-gray-50 flex items-center justify-center mb-6 group-hover:bg-black group-hover:text-white transition-colors">
                <Icon name={serviceIconMap[service.slug] || 'shield-check'} size="sm" />
              </div>
              <h3 class="text-lg font-bold text-gray-900 mb-2 group-hover:translate-x-1 transition-transform">{service.title}</h3>
              <p class="text-sm text-gray-500 leading-relaxed">{service.tagline}</p>
            </a>
          ))
        }
      </div>
    </Container>
  </Section>

  <!-- Local Benefits -->
  <Section background="white">
    <Container>
      <div class="mb-16 text-center">
        <h2 class="text-3xl md:text-4xl font-semibold text-gray-900 mb-4 tracking-tight">
          Presencia local estratégica
        </h2>
        <p class="text-gray-500 text-lg">Comprometidos con la seguridad de {commune.name}.</p>
      </div>

      <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-12">
        {
          localBenefits.map((benefit) => (
            <div class="group">
              <div class="w-12 h-12 mb-6 bg-gray-900 text-white rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                <Icon
                  name={benefit.icon as any}
                  size="sm"
                />
              </div>
              <h3 class="text-lg font-bold text-gray-900 mb-3 uppercase tracking-wider">
                {benefit.title}
              </h3>
              <p class="text-gray-500 text-sm leading-relaxed">
                {benefit.description}
              </p>
            </div>
          ))
        }
      </div>
    </Container>
  </Section>

  <!-- Coverage Area - Shows other communes in same zone -->
  <Section background="gray">
    <Container>
      <div class="max-w-4xl mx-auto">
        <div class="text-center mb-10">
          <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
            Zona de Cobertura - {zoneDisplayName}
          </h2>
          <p class="text-gray-600 max-w-2xl mx-auto">
            Además de {commune.name}, operamos en otras comunas de la {
              zoneDisplayName
            }. Nuestra red de guardias y patrullas cubre extensamente la zona,
            permitiendo una respuesta coordinada y eficiente ante cualquier
            eventualidad.
          </p>
        </div>

        <div class="flex flex-wrap gap-2 justify-center">
          {
            zoneCommunes.map((c) =>
              c.slug === commune.slug ? (
                <span class="px-3 py-1.5 bg-gray-900 text-white rounded-full text-sm font-medium">
                  {c.name}
                </span>
              ) : (
                <a
                  href={`/cobertura/${c.slug}`}
                  class="px-3 py-1.5 bg-white text-gray-900 rounded-full text-sm font-medium hover:bg-gray-900 hover:text-white transition-colors shadow-sm"
                >
                  {c.name}
                </a>
              )
            )
          }
        </div>
      </div>
    </Container>
  </Section>

  <!-- CTA Section -->
  <Section background="dark">
    <Container>
      <div class="text-center max-w-4xl mx-auto">
        <h2 class="text-3xl md:text-5xl font-semibold text-white mb-8 tracking-tight">
          Asegure su propiedad en {commune.name}
        </h2>
        <p class="text-lg md:text-xl text-white/50 mb-12 leading-relaxed">
          Diseñamos planes de seguridad a medida para empresas y comunidades residenciales.
        </p>

        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <Button href="/cotizar" variant="accent" size="lg" class="bg-white text-black hover:bg-gray-100 border-none">
            Solicitar propuesta gratuita
          </Button>
          <Button
            href={getWhatsAppUrl(`Hola, necesito información sobre servicios de seguridad en ${commune.name}`)}
            target="_blank"
            variant="outline"
            size="lg"
            class="border-white/20 hover:bg-white/10 text-white"
          >
            Contactar asesor
          </Button>
        </div>
      </div>
    </Container>
  </Section>
</BaseLayout>
