---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getConvexServer } from "../../lib/convex";

export const prerender = false;

// Get Convex client
const convex = await getConvexServer();
let locations = { communes: [], otherCities: [] };
let error = null;

if (convex) {
  try {
    locations = await convex.query("locations:getAllLocations", {});
  } catch (e: any) {
    console.error("Error fetching locations:", e);
    error = e.message;
  }
} else {
  error = "Convex client not available";
}

// Group communes by zone
const zones = {
  centro: locations.communes.filter((c: any) => c.zone === 'centro'),
  norte: locations.communes.filter((c: any) => c.zone === 'norte'),
  sur: locations.communes.filter((c: any) => c.zone === 'sur'),
  oriente: locations.communes.filter((c: any) => c.zone === 'oriente'),
  poniente: locations.communes.filter((c: any) => c.zone === 'poniente'),
};

const zoneLabels: Record<string, string> = {
  centro: 'Centro',
  norte: 'Norte',
  sur: 'Sur',
  oriente: 'Oriente',
  poniente: 'Poniente',
};
---

<BaseLayout
  title="Cobertura | Guardman Chile"
  description="Cobertura de servicios de seguridad en toda la Región Metropolitana y ciudades principales de Chile."
>
  <!-- Hero Section -->
  <section class="bg-gradient-to-br from-green-900 to-green-700 text-white py-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <h1 class="text-4xl md:text-5xl font-bold mb-4">
        Cobertura Geográfica
      </h1>
      <p class="text-xl text-green-100 max-w-3xl">
        Ofrecemos servicios de seguridad privada en toda la Región Metropolitana 
        y en las principales ciudades de Chile.
      </p>
    </div>
  </section>

  {error && (
    <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 mx-auto max-w-7xl my-8">
      <p>Error cargando ubicaciones: {error}</p>
    </div>
  )}

  {/* Coverage Map Placeholder */}
  <section class="py-16 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-12">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">Región Metropolitana</h2>
        <p class="text-gray-600 max-w-2xl mx-auto">
          Presencia en todas las comunas de Santiago y alrededores, con equipos de respuesta rápida 
          disponibles 24/7.
        </p>
      </div>

      {/* Zones Grid */}
      <div class="space-y-12">
        {Object.entries(zones).map(([zoneKey, communes]) => (
          communes.length > 0 && (
            <div>
              <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
                <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                Zona {zoneLabels[zoneKey]}
              </h3>
              <div class="flex flex-wrap gap-3">
                {communes.map((commune: any) => (
                  <a
                    href={`/cobertura/${commune.slug}`}
                    class="px-4 py-2 bg-white rounded-lg shadow-sm hover:shadow-md hover:bg-green-50 transition text-gray-700 hover:text-green-700 font-medium"
                  >
                    {commune.name}
                  </a>
                ))}
              </div>
            </div>
          )
        ))}
      </div>
    </div>
  </section>

  {/* Other Cities */}
  {locations.otherCities.length > 0 && (
    <section class="py-16 bg-white">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-4 text-center">
          Otras Ciudades
        </h2>
        <p class="text-gray-600 text-center mb-8 max-w-2xl mx-auto">
          También ofrecemos servicios especializados en las principales ciudades de Chile.
        </p>
        <div class="flex flex-wrap justify-center gap-4">
          {locations.otherCities.map((city: any) => (
            <a
              href={`/cobertura/${city.slug}`}
              class="px-6 py-3 bg-green-50 text-green-700 rounded-lg hover:bg-green-100 transition font-medium"
            >
              {city.name}
            </a>
          ))}
        </div>
      </div>
    </section>
  )}

  {/* CTA Section */}
  <section class="py-16 bg-green-600">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <h2 class="text-3xl font-bold text-white mb-4">
        ¿Tu ubicación no está en la lista?
      </h2>
      <p class="text-xl text-green-100 mb-8">
        Contáctanos para verificar cobertura en tu zona
      </p>
      <a 
        href="/contacto"
        class="inline-block bg-white text-green-700 font-semibold px-8 py-4 rounded-lg hover:bg-gray-100 transition"
      >
        Solicitar Cotización
      </a>
    </div>
  </section>
</BaseLayout>
