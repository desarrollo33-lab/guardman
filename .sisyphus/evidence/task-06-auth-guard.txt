# Task 6: Admin Layout + Auth Guard - Implementation Evidence

## Files Created

### 1. src/components/admin/AuthGuard.tsx
- React component that protects admin routes
- Uses `useConvexAuth()` from `convex/react` to check authentication status
- Shows loading spinner while checking auth
- Redirects to /admin/login if not authenticated
- Renders children only when authenticated

### 2. src/components/admin/LoginForm.tsx
- React login form component using Convex Auth
- Uses `useAuthActions()` from `@convex-dev/auth/react` for signIn
- Handles email/password authentication
- Shows error messages for failed login attempts
- Redirects to /admin on successful login

### 3. src/components/admin/LogoutButton.tsx
- React logout button component
- Uses `useAuthActions()` from `@convex-dev/auth/react` for signOut
- Redirects to /admin/login after logout

## Files Modified

### 1. src/pages/admin/login.astro
- Updated to use Convex Auth (LoginForm component)
- Wrapped with AuthProvider
- Removed old cookie-based authentication

### 2. src/layouts/AdminLayout.astro
- Added AuthProvider wrapper
- Replaced form-based logout with LogoutButton component
- Maintains existing styling and structure

### 3. src/components/admin/ConvexDashboard.tsx
- Added AuthGuard wrapper around Dashboard component
- Provides both Convex context and auth protection

### 4. src/components/admin/ConvexLeadsList.tsx
- Added AuthGuard wrapper around LeadsList component
- Provides both Convex context and auth protection

### 5. src/components/admin/ConvexLeadDetail.tsx
- Added AuthGuard wrapper around LeadDetail component
- Provides both Convex context and auth protection

## Key Patterns

### Auth Provider Setup
```tsx
// src/lib/auth.tsx
import { ConvexAuthProvider, useAuthActions } from '@convex-dev/auth/react';
import { convex } from './convex';

export function AuthProvider({ children }: { children: ReactNode }) {
  return <ConvexAuthProvider client={convex}>{children}</ConvexAuthProvider>;
}
```

### Auth Guard Pattern
```tsx
import { useConvexAuth } from 'convex/react';

export default function AuthGuard({ children, redirectTo = '/admin/login' }) {
  const { isLoading, isAuthenticated } = useConvexAuth();

  if (isLoading) return <LoadingSpinner />;
  if (!isAuthenticated) return <RedirectToLogin to={redirectTo} />;
  return <>{children}</>;
}
```

### Login Flow
```tsx
import { useAuthActions } from '@convex-dev/auth/react';

const { signIn } = useAuthActions();
await signIn('password', formData); // FormData with email, password, flow
```

### Logout Flow
```tsx
import { useAuthActions } from '@convex-dev/auth/react';

const { signOut } = useAuthActions();
await signOut();
window.location.href = '/admin/login';
```

## Verification Steps

1. Navigate to /admin without auth
   - Expected: Redirects to /admin/login
   
2. Login with valid credentials
   - Expected: Redirects to /admin dashboard
   
3. Logout
   - Expected: Redirects to /admin/login
   
4. Try to access /admin/leads without auth
   - Expected: Redirects to /admin/login

## Dependencies

- `@convex-dev/auth` (already installed)
- `convex/react` (from convex package)
- Auth tables in schema (authTables)

## Notes

- Single admin user model (no roles)
- Uses password authentication
- AuthGuard is added to all admin wrapper components
- AdminLayout includes AuthProvider for all child components
